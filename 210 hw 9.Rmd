---
title: "BST 210 HW 9"
output: html_document
---
Suppose you wish to design a prospective cohort study assessing whether obesity (BMI ≥ 30) is associated with presence or absence of coronary heart disease (CHD) or time to CHD. Because we don’t want to wait 24 years to collect our data (!!!), a consistent four-year follow-up is planned for each subject. Future subjects were expected to look similar to those in the Framingham study.

A pilot study of 250 Framingham-like subjects was run, excluding subjects who already had prevalent CHD. First, we look at presence or absence of obesity to predict a binary four-year CHD incidence. Subjects who died within four years without having a prior CHD were viewed as not developing CHD.

Among the 250 subjects, 3 of 31 obese (BMI ≥ 30) subjects developed CHD within 4 years and 11 of 219 non-obese subjects developed CHD within 4 years. Using logistic regression, the estimated odds ratio comparing obese vs. non-obese subjects was 2.025974 with 95% confidence interval (0.5325236, 7.707772).

Next, we look at presence or absence of obesity to predict time to CHD, with right censoring occurring at four years for subjects who did not have CHD by that time. Subjects who died without having a prior CHD were viewed as being censored at their time of death. Among these same 250 subjects, the estimated hazard ratio from the proportional hazards model comparing obese vs. non-obese subjects was 1.990321 with 95% confidence interval (0.5552206, 7.134780). Not surprisingly, given only 250 subjects, we did not reach statistical significance with either analysis. View this data as informative historical data (and ignore the analysis of the full Framingham data farther below for now).

(a) Determine the sample size needed for 90% power in a two-sided 0.05 level test to compare proportions of incident CHD over four years in obese vs. non-obese subjects if, under the alternative hypothesis, we had proportions with incident CHD as observed in the 250 subjects. Keep the proportions of obese and non-obese subjects the same as observed in the pilot study.
       n1        n2 
 411.2074 2904.9811 
 We need 412 obese individuals and 2905 non-obses individuals in our study to ensure a 90% power in a two-sided 0.05 level test to compare proportions of incident CHD over four years in obses vs. non-obses subjects. 
```{r}
library(Hmisc)
p_ob = 3 / 31
p_nob = 11 / 219
fr = 31 / 250

bsamsize(p1 = p_ob, p2 = p_nob, fraction = fr, alpha = 0.025, power = 0.9)

```

(b) Determine the sample size needed for 90% power in a two-sided 0.05 level log rank test to compare times to CHD in obese vs. non-obese subjects if, under the alternative hypothesis, we had a hazard ratio as observed in the 250 subjects. Keep the proportions of obese vs. non-obese subjects the same as observed, as well as the proportion of censored observations.
  nE   nC 
 326 2299 
 We need 326 obese individuals and 2299 non-obese individuals for a 90% power two-sided 0.05 alpha level log rank test that compares time to CHD in obses vs non-obsese individuals. 
```{r}
library(powerSurvEpi)

power = .9
k = 31/ 219
pE = p_ob
pC = p_nob
RR = 1.99
ssizeCT.default(power, k, pE, pC, RR, alpha = 0.025)
```

(c) How do the sample sizes change if we designed each of the studies above to have an equal number of obese vs. non-obese subjects? Is the total sample size larger or smaller? Does that make intuitive sense? Briefly comment on the feasibility of such a design.
      n1       n2 
777.9668 777.9668 
We need 778 individuals from obese and non-obese population for our first two proportions test.
 nE  nC 
771 771 
We need 771 individuals from obese and non-obese population for our second log rank test. 

If we designed each of the studies to have an equal number of obese vs. non-obese subjects, the total sample size needed is smaller. This is because the variance of datapoints in our study is minimized by having equal proportions in treated and control. This is likely feasible for our study because obesity is present on a wide-scale in the States (with estimations of around 30-40% of adult Americans being obese). We should not have too much issue recruiting individuals from either obese or non-obese population. *** 
```{r}
fr = 0.5
bsamsize(p1 = p_ob, p2 = p_nob, fraction = fr, alpha = 0.025, power = 0.9)

k = 1
ssizeCT.default(power, k, pE, pC, RR, alpha = 0.025)
```

(d) If you had to pick “one primary outcome” for your study, would you prefer to design this study to have a binary or a time-to-event outcome? Briefly justify your choice.
Time-to-event outcome makes more sense in this situation because there is more valuable information in the time to CHD differences between the two populations. We would be able to find interesting differences even if the final proportions of patients with CHD are the same in the two groups -- if one group has statistically significant shorter time to CHD than another group, then it is a health and mortality risk that would be clinically useful to know. It also appears that TTE study in this scenario requires a smaller sample size to achieve the same alpha level and power, so that is another advantage in terms of costs and resources of the study. 

(e) In practice, one would use more “rounded” values for OR’s, HR’s, or proportions of obese or censored observations than done above, as you would not exactly believe the estimates from the sample size of 250. It would also be important to perform a range of calculations to show power or sample size under different scenarios. 

Using your “one primary outcome” selected above, develop an appropriate sample size based on your parameter of interest (either OR or HR) of 2.0 for 90% power for a two-sided 0.05 level test. Then, develop a table and/or graph for a range of 1.5 to 2.5 in increments of 0.1 for your parameter of interest, for a fixed sample size to show changes in power resulting under different scenarios.

I would need a total sample size of 920 based on HR of 2.0 as a parameter of interest for a 90% power in a two-sided 0.05 level test, assuming equal recruitment of obese/non-obese study participants. 

Also include a sentence or two summarizing your results that would be appropriate to include in a protocol or grant application. Feel free to add or adjust anything here that seems reasonable to you – different reasonable researchers might use different assumptions and so would end up with different sample sizes, so be sure that your sentences summarizing your results include all necessary information about your assumptions.

Hazard Ratio	1.5	1.6	1.7	1.8	1.9	2	2.1	2.2	2.3	2.4	2.5
Sample Size needed	4222.0	3172.0	2514.0	2070.0	1754.0	1520	1342.0	1202.0	1090.0	996.0	920.0

Based on the hazard ratio obtained from our 250 individual pilot study, and assuming that equal proportions of obese vs non-obese study participants may be recruited, 920 individuals are needed to guarantee 90% power at two-sided alpha level of 0.05. However, as hazard ratios are rarely fixed as estimated from a pilot study, a range of possible hazard ratios center around 2.0 (the estimated HR obtained from our pilo study) was considered and each of their corresponding sample sizes needed to obtain 90% power and 0.05 alpha level for a two-sided test was obtained. See Table below for the full range of sample sizes based on the interval of hazard ratios considered. Hazard ratios closer to 1 require greater sample sizes to achieve the same power. 
```{r}
library(powerSurvEpi)

power = .9
k = 1
pE = p_ob
pC = p_nob
RR = 2.0
ssizeCT.default(power, k, pE, pC, RR, alpha = 0.025)

ss_needed = c()
HRs = seq(1.5, 2.5, 0.1)
for (i in HRs){
  RR = i
  s = ssizeCT.default(power, k, pE, pC, RR, alpha = 0.025)[1] * 2
  ss_needed = c(ss_needed, s)
}

library(dplyr)
library(knitr)
data.frame(HRs, ss_needed) %>% t(.) %>% `rownames<-`(c("Hazard Ratio", "Sample Size needed")) %>% kable
```


(f) Analyses from the “full” Framingham data set are below, restricting follow-up to four years to develop CHD for each subject and eliminating subjects with incident CHD or missing BMI. How close were your assumptions in your sample size calculations to the “truth” from the full data set? Were the sample sizes that were actually achieved sufficient for high power? Briefly comment.

My assumptions were off firstly regarding sample proportions of obese vs non-obese individuals. I assumed that an equal number of obese/non-obese participants could be recruited for the study. However, as Framingham was a large observational cohort study, obesity would not have been a primary variable that would be preferentially recruited for. The HR estimation of 1.62 (1.14 - 2.29) was within the bounds of the range of hazard ratios considered, however, it was not the ratio considered for my intial analysis based on HR of 2.0. In reality, if we calculated the sample size from our pilot study and conducted the study based on that sample size, our study would have been underpowered if the Framingham study results are closer to reality.
The sample size was able to achieve sufficient power, with a log rank test with p value of 0.0063. 

(g) A colleague noted that the relative risk, the odds ratio, and the hazard ratio estimates in these analyses were similar. Also, that logistic regression, the log rank test, and the Cox model gave similar P-values. Briefly discuss whether these observations make sense or not.

(Note that even more work would be needed if we also wanted to account for other covariates or confounders, such as adjusting for gender or age, in our comparisons of obese vs. non-obese subjects.)

These observations make sense as OR can closely approximate RR when the incidence of disease is small, as in our case (7% of obese patients developed CHD, 4.6% of non-obese patients developed CHD). Moreover, RR is closely related to HR, whereas RR assumed constant baseline hazards rate, Cox PH allows for varing baseline hazards rate and assumes constant hazards ratio. 


